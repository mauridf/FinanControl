<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             x:Class="FinanControl.App.Views.TransacoesPage"
             Title="Transações"
             xmlns:viewmodel="clr-namespace:FinanControl.App.ViewModels"
             x:DataType="viewmodel:TransacoesViewModel"
             xmlns:converters="clr-namespace:FinanControl.App.Converters"
             xmlns:toolkit="http://schemas.microsoft.com/dotnet/2022/maui/toolkit">

    <ContentPage.Resources>
        <converters:NotNullToBoolConverter x:Key="NotNullToBoolConverter" />
        <converters:TipoTransacaoToColorConverter x:Key="TipoTransacaoToColorConverter" />
        <converters:BoolToColorConverter x:Key="BoolToColorConverter" />
        <converters:BoolToStatusConverter x:Key="BoolToStatusConverter" />
    </ContentPage.Resources>

    <Grid RowDefinitions="Auto, *, Auto" 
          ColumnDefinitions="*"
          Padding="20"
          RowSpacing="15">

        <!-- Formulário -->
        <Frame Grid.Row="0"
               BorderColor="{StaticResource Primary}"
               CornerRadius="10"
               Padding="15"
               HasShadow="True">
            <VerticalStackLayout Spacing="10">
                <Grid ColumnDefinitions="*, *" 
                      RowDefinitions="Auto, Auto, Auto, Auto"
                      ColumnSpacing="10"
                      RowSpacing="10">

                    <Label Grid.Row="0" Grid.Column="0"
                           Text="Descrição:*"
                           VerticalOptions="Center"
                           FontSize="14"/>
                    <Entry Grid.Row="0" Grid.Column="1"
                           Text="{Binding Descricao}"
                           Placeholder="Ex: Pagamento de conta"
                           ClearButtonVisibility="WhileEditing"/>

                    <Label Grid.Row="1" Grid.Column="0"
                           Text="Valor:*"
                           VerticalOptions="Center"
                           FontSize="14"/>
                    <Entry Grid.Row="1" Grid.Column="1"
                           Text="{Binding Valor, StringFormat='{0:F2}'}"
                           Placeholder="0,00"
                           Keyboard="Numeric"
                           ClearButtonVisibility="WhileEditing"/>

                    <Label Grid.Row="2" Grid.Column="0"
                           Text="Tipo:*"
                           VerticalOptions="Center"
                           FontSize="14"/>
                    <Picker Grid.Row="2" Grid.Column="1"
                            ItemsSource="{Binding TiposTransacao}"
                            SelectedItem="{Binding Tipo}"
                            Title="Selecione o tipo"/>

                    <Label Grid.Row="3" Grid.Column="0"
                           Text="Data:*"
                           VerticalOptions="Center"
                           FontSize="14"/>
                    <DatePicker Grid.Row="3" Grid.Column="1"
                                Date="{Binding Data}"
                                Format="dd/MM/yyyy"/>

                </Grid>

                <Grid ColumnDefinitions="*, *" 
                      RowDefinitions="Auto, Auto"
                      ColumnSpacing="10"
                      RowSpacing="10">

                    <Label Grid.Row="0" Grid.Column="0"
                           Text="Conta:*"
                           VerticalOptions="Center"
                           FontSize="14"/>
                    <Picker Grid.Row="0" Grid.Column="1"
                            ItemsSource="{Binding Contas}"
                            SelectedIndex="{Binding ContaIndex}"
                            ItemDisplayBinding="{Binding Nome}"
                            Title="Selecione a conta" />

                    <Label Grid.Row="1" Grid.Column="0"
                           Text="Categoria:*"
                           VerticalOptions="Center"
                           FontSize="14"/>
                    <Picker Grid.Row="1" Grid.Column="1"
                            ItemsSource="{Binding Categorias}"
                            SelectedIndex="{Binding CategoriaIndex}"
                            ItemDisplayBinding="{Binding Nome}"
                            Title="Selecione a categoria" />

                </Grid>

                <Grid ColumnDefinitions="*, *" 
                      RowDefinitions="Auto, Auto"
                      ColumnSpacing="10"
                      RowSpacing="10">

                    <StackLayout Grid.Row="0" Grid.Column="0"
                                 Orientation="Horizontal"
                                 Spacing="10">
                        <CheckBox IsChecked="{Binding Efetivada}"
                                  Color="{StaticResource Primary}"/>
                        <Label Text="Efetivada"
                               VerticalOptions="Center"
                               FontSize="14"/>
                    </StackLayout>

                    <StackLayout Grid.Row="0" Grid.Column="1"
                                 Orientation="Horizontal"
                                 Spacing="10">
                        <CheckBox IsChecked="{Binding Recorrente}"
                                  Color="{StaticResource Primary}"/>
                        <Label Text="Recorrente"
                               VerticalOptions="Center"
                               FontSize="14"/>
                    </StackLayout>

                </Grid>

                <Label Text="Observação:"
                       FontSize="14"/>
                <Editor Text="{Binding Observacao}"
                        Placeholder="Observações (opcional)"
                        AutoSize="TextChanges"
                        HeightRequest="60"/>
            </VerticalStackLayout>
        </Frame>

        <!-- Lista de Transações -->
        <Frame Grid.Row="1"
               BorderColor="{StaticResource Secondary}"
               CornerRadius="10"
               Padding="0"
               HasShadow="True">
            <RefreshView IsRefreshing="{Binding IsBusy}"
                         Command="{Binding CarregarDadosCommand}">
                <CollectionView ItemsSource="{Binding Transacoes}"
                                SelectionMode="Single"
                                SelectedItem="{Binding TransacaoSelecionada}">
                    <CollectionView.ItemTemplate>
                        <DataTemplate>
                            <Frame Padding="15"
                                   Margin="5"
                                   CornerRadius="8"
                                   BackgroundColor="{Binding Tipo, Converter={StaticResource TipoTransacaoToColorConverter}}">
                                <Grid ColumnDefinitions="*, Auto"
                                      RowDefinitions="Auto, Auto, Auto">

                                    <Label Grid.Row="0" Grid.Column="0"
                                           Text="{Binding Descricao}"
                                           FontSize="16"
                                           FontAttributes="Bold"
                                           TextColor="White"/>

                                    <Label Grid.Row="1" Grid.Column="0"
                                           Text="{Binding Categoria.Nome}"
                                           FontSize="12"
                                           TextColor="White"/>

                                    <Label Grid.Row="2" Grid.Column="0"
                                           Text="{Binding Data, StringFormat='{0:dd/MM/yyyy}'}"
                                           FontSize="11"
                                           TextColor="White"/>

                                    <Label Grid.Row="0" Grid.Column="1"
                                           Text="{Binding Valor, StringFormat='R$ {0:F2}'}"
                                           FontSize="18"
                                           FontAttributes="Bold"
                                           HorizontalOptions="End"
                                           TextColor="White"/>

                                    <Label Grid.Row="1" Grid.Column="1"
                                           Text="{Binding Conta.Nome}"
                                           FontSize="12"
                                           HorizontalOptions="End"
                                           TextColor="White"/>

                                    <StackLayout Grid.Row="2" Grid.Column="1"
                                                 Orientation="Horizontal"
                                                 Spacing="5"
                                                 HorizontalOptions="End">
                                        <Label Text="●"
                                               FontSize="8"
                                               VerticalOptions="Center"
                                               TextColor="{Binding Efetivada, Converter={StaticResource BoolToColorConverter}}"/>
                                        <Label Text="{Binding Efetivada, Converter={StaticResource BoolToStatusConverter}}"
                                               FontSize="11"
                                               TextColor="White"/>
                                    </StackLayout>
                                </Grid>
                            </Frame>
                        </DataTemplate>
                    </CollectionView.ItemTemplate>

                    <CollectionView.EmptyView>
                        <StackLayout HorizontalOptions="Center"
                                     VerticalOptions="Center"
                                     Padding="40">
                            <Label Text="Nenhuma transação este mês"
                                   HorizontalOptions="Center"
                                   FontSize="16"
                                   TextColor="{StaticResource MediumGray}"/>
                            <Label Text="Adicione sua primeira transação usando o formulário acima"
                                   HorizontalOptions="Center"
                                   FontSize="14"
                                   TextColor="{StaticResource MediumGray}"/>
                        </StackLayout>
                    </CollectionView.EmptyView>
                </CollectionView>
            </RefreshView>
        </Frame>

        <!-- Botões -->
        <Grid Grid.Row="2"
              ColumnDefinitions="*, *, *, *"
              ColumnSpacing="10">

            <Button Grid.Column="0"
                    Text="Novo"
                    Command="{Binding NovoCommand}"
                    BackgroundColor="{StaticResource Primary}"
                    TextColor="White"/>

            <Button Grid.Column="1"
                    Text="Salvar"
                    Command="{Binding SalvarCommand}"
                    BackgroundColor="{StaticResource Success}"
                    TextColor="White"
                    IsEnabled="{Binding IsNotBusy}"/>

            <Button Grid.Column="2"
                    Text="Editar"
                    Command="{Binding EditarCommand}"
                    BackgroundColor="{StaticResource Warning}"
                    TextColor="White"
                    IsEnabled="{Binding TransacaoSelecionada, Converter={StaticResource NotNullToBoolConverter}}"/>

            <Button Grid.Column="3"
                    Text="Excluir"
                    Command="{Binding ExcluirCommand}"
                    BackgroundColor="{StaticResource Danger}"
                    TextColor="White"
                    IsEnabled="{Binding TransacaoSelecionada, Converter={StaticResource NotNullToBoolConverter}}"/>

        </Grid>

        <ActivityIndicator IsRunning="{Binding IsBusy}" 
                          IsVisible="{Binding IsBusy}"
                          Color="{StaticResource Primary}"
                          Grid.RowSpan="3"
                          HorizontalOptions="Center"
                          VerticalOptions="Center"/>

    </Grid>
</ContentPage>